<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Prepaid Recharge Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <link href="AdminStyle.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">
    <header>
        <div>
            <nav class="navbar navbar-light fixed-top w-100 mb-5">
                <div class="container-fluid">
                    <a class="navbar-brand" href="Admin_login.html">
                        <img src="Assets/Images/logo.png" alt="logo" width="38" height="34" class="d-inline-block align-text-center">
                        <h1 class="h1 as h3 d-inline-block align-text-center text-light fw-bold">MOBICOMM</h1>
                    </a>
                    <div class="me-3">
                        <div class="d-flex align-items-center">
                            <a class="navbar-brand" href="#" role="button" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <img src="Assets/Images/profile-icon.png" class="float-end me-3" alt="Profile" width="35" height="35">
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end me-3" aria-labelledby="profileDropdown">
                                <li><a class="dropdown-item" href="#">Help</a></li>
                                <li><a class="dropdown-item" type="button" href="Admin_login.html">LogOut</a></li>
                            </ul>
                        </div>
                    </div>    
                </div>
            </nav>
        </div>
    </header>
    <div class="d-flex">
        <!-- Sidebar -->
        <div class="bg-white shadow-sm mt-4" style="width: 250px;">
            <h2 class="text-primary ms-3">RechargeApp</h2>
            <nav class="nav flex-column mt-4">
                <a class="nav-link active text-primary" href="#"><i class="fas fa-home me-2"></i>Dashboard</a>
                <a class="nav-link text-dark" href="#" data-bs-toggle="modal" data-bs-target="#plansManagementModal">
                    <i class="fas fa-cogs me-2"></i>Plans Management
                </a>
                <a class="nav-link text-dark" href="#" data-bs-toggle="modal" data-bs-target="#customerManagementModal">
                    <i class="fas fa-users me-2"></i>Customer Management
                </a>
                <a class="nav-link text-dark" href="#" data-bs-toggle="modal" data-bs-target="#customerManagementModal">
                    <i class="fas fa-chart-line me-2"></i>Analytics
                </a>
                 
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-grow-1 p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Dashboard</h2>
                
            </div>

            <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />

            <div class="container">
            <div class="row row-cols-1 row-cols-md-2 row-cols-xl-4">
                <div class="col">
                    <div class="card radius-10 border-start border-0 border-3 border-info">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div>
                                    <p class="mb-0 text-secondary">Total Orders</p>
                                    <h4 class="my-1 text-info">4805</h4>
                                    <p class="mb-0 font-13">+2.5% from last week</p>
                                </div>
                                <div class="widgets-icons-2 rounded-circle bg-gradient-scooter text-white ms-auto"><i class="fa fa-shopping-cart"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card radius-10 border-start border-0 border-3 border-danger">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <p class="mb-0 text-secondary">Total Revenue</p>
                                <h4 class="my-1 text-danger">$84,245</h4>
                                <p class="mb-0 font-13">+5.4% from last week</p>
                            </div>
                            <div class="widgets-icons-2 rounded-circle bg-gradient-bloody text-white ms-auto"><i class="fa fa-dollar"></i>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card radius-10 border-start border-0 border-3 border-success">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <p class="mb-0 text-secondary">Bounce Rate</p>
                                <h4 class="my-1 text-success">34.6%</h4>
                                <p class="mb-0 font-13">-4.5% from last week</p>
                            </div>
                            <div class="widgets-icons-2 rounded-circle bg-gradient-ohhappiness text-white ms-auto"><i class="fa fa-bar-chart"></i>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card radius-10 border-start border-0 border-3 border-warning">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <p class="mb-0 text-secondary">Total Customers</p>
                                <h4 class="my-1 text-warning">8.4K</h4>
                                <p class="mb-0 font-13">+8.4% from last week</p>
                            </div>
                            <div class="widgets-icons-2 rounded-circle bg-gradient-blooker text-white ms-auto"><i class="fa fa-users"></i>
                            </div>
                        </div>
                    </div>
                    </div>
                </div> 
                </div>
            </div>

            <!-- Expiring Plans Table -->
            <div class="card mb-4">
                <div class="card-header">
                    Customers with Plans Expiring Soon
                </div>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Previous Plan</th>
                            <th>Expiry Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="customerTableBody">
                        <!-- Data will be inserted dynamically -->
                    </tbody>
                </table>
            </div>
            <div class="container">
                <div class="row ">
                    <div class="col-xl-6 col-lg-6">
                        <div class="card l-bg-cherry">
                            <div class="card-statistic-3 p-4">
                                <div class="card-icon card-icon-large"><i class="fas fa-shopping-cart"></i></div>
                                <div class="mb-4">
                                    <h5 class="card-title mb-0">New Orders</h5>
                                </div>
                                <div class="row align-items-center mb-2 d-flex">
                                    <div class="col-8">
                                        <h2 class="d-flex align-items-center mb-0">
                                            3,243
                                        </h2>
                                    </div>
                                    <div class="col-4 text-right">
                                        <span>12.5% <i class="fa fa-arrow-up"></i></span>
                                    </div>
                                </div>
                                <div class="progress mt-1 " data-height="8" style="height: 8px;">
                                    <div class="progress-bar l-bg-cyan" role="progressbar" data-width="25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" style="width: 25%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-6 col-lg-6">
                        <div class="card l-bg-blue-dark">
                            <div class="card-statistic-3 p-4">
                                <div class="card-icon card-icon-large"><i class="fas fa-users"></i></div>
                                <div class="mb-4">
                                    <h5 class="card-title mb-0">New Customers</h5>
                                </div>
                                <div class="row align-items-center mb-2 d-flex">
                                    <div class="col-8">
                                        <h2 class="d-flex align-items-center mb-0">
                                            15.07k
                                        </h2>
                                    </div>
                                    <div class="col-4 text-right">
                                        <span>9.23% <i class="fa fa-arrow-up"></i></span>
                                    </div>
                                </div>
                                <div class="progress mt-1 " data-height="8" style="height: 8px;">
                                    <div class="progress-bar l-bg-green" role="progressbar" data-width="25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" style="width: 60%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-6 col-lg-6">
                        <div class="card l-bg-green-dark">
                            <div class="card-statistic-3 p-4">
                                <div class="card-icon card-icon-large"><i class="fas fa-ticket-alt"></i></div>
                                <div class="mb-4">
                                    <h5 class="card-title mb-0">Rewards claimed</h5>
                                </div>
                                <div class="row align-items-center mb-2 d-flex">
                                    <div class="col-8">
                                        <h2 class="d-flex align-items-center mb-0">
                                            578
                                        </h2>
                                    </div>
                                    <div class="col-4 text-right">
                                        <span>10% <i class="fa fa-arrow-up"></i></span>
                                    </div>
                                </div>
                                <div class="progress mt-1 " data-height="8" style="height: 8px;">
                                    <div class="progress-bar l-bg-orange" role="progressbar" data-width="25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" style="width: 70%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-6 col-lg-6">
                        <div class="card l-bg-orange-dark">
                            <div class="card-statistic-3 p-4">
                                <div class="card-icon card-icon-large"><i class="fas fa-dollar-sign"></i></div>
                                <div class="mb-4">
                                    <h5 class="card-title mb-0">Revenue Today</h5>
                                </div>
                                <div class="row align-items-center mb-2 d-flex">
                                    <div class="col-8">
                                        <h2 class="d-flex align-items-center mb-0">
                                            ₹116.1Lakh
                                        </h2>
                                    </div>
                                    <div class="col-4 text-right">
                                        <span>2.5% <i class="fa fa-arrow-up"></i></span>
                                    </div>
                                </div>
                                <div class="progress mt-1 " data-height="8" style="height: 8px;">
                                    <div class="progress-bar l-bg-cyan" role="progressbar" data-width="25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" style="width: 25%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>



    <!-- Customer Details Modal -->
    <div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerModalLabel">Customer Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="customerDetails">
                    <!-- Customer details will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Management Modal -->
    <div class="modal fade" id="customerManagementModal" tabindex="-1" aria-labelledby="customerManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerManagementModalLabel">Customer Management</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Search customers..." id="customerSearchInput">
                                <button class="btn btn-outline-secondary" type="button" id="customerSearchButton">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" id="planStatusFilter">
                                <option value="all">All Users</option>
                                <option value="active">Active Plans</option>
                                <option value="inactive">Inactive Plans</option>
                                <option value="expiring">Expiring Soon</option>
                            </select>
                        </div>
                    </div>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Mobile Number</th>
                                <th>Current Plan</th>
                                <th>Status</th>
                                <th>Expiry Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="customerManagementTableBody">
                            <!-- Data will be inserted dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Plans Management Modal -->
    <div class="modal fade" id="plansManagementModal" tabindex="-1" aria-labelledby="plansManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="plansManagementModalLabel">Plans Management</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="planCategory" class="form-label">Plan Category</label>
                        <select class="form-control" id="planCategory" required>
                            <option value="popularPlan">Popular Plans</option>
                            <option value="unlimitedPlans">Unlimited Plans</option>
                            <option value="validityPlans">Validity Plans</option>
                            <option value="dataPlans">Data Plans</option>
                            <option value="talkTimePlans">TalkTime Plans</option>
                            <option value="roamingPlans">Roaming Plans</option>
                            <option value="specialOffers">Special Offers</option>
                            <option value="SuperSaver">Super Saver Plans</option>
                        </select>
                    </div>
                    <button class="btn btn-success mb-3" id="addNewPlanBtn">Add New Plan</button>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Plan ID</th>
                                <th>Price</th>
                                <th>Validity</th>
                                <th>Data</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="plansTable">
                            <!-- Plans will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Plan Modal -->
    <div class="modal fade" id="addPlanModal" tabindex="-1" aria-labelledby="addPlanModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPlanModalLabel">Add / Edit Plan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="planForm">
                        <input type="hidden" id="editIndex"> <!-- Hidden field to track edits -->
                        <div class="mb-3">
                            <label for="planId" class="form-label">Plan ID</label>
                            <input type="text" class="form-control" id="planId" required>
                        </div>
                        <div class="mb-3">
                            <label for="planPrice" class="form-label">Price</label>
                            <input type="text" class="form-control" id="planPrice" required>
                        </div>
                        <div class="mb-3">
                            <label for="planValidity" class="form-label">Validity</label>
                            <input type="text" class="form-control" id="planValidity" required>
                        </div>
                        <div class="mb-3">
                            <label for="planData" class="form-label">Data</label>
                            <input type="text" class="form-control" id="planData" required>
                        </div>
                        <div class="mb-3">
                            <label for="planDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="planDescription" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="planStatus" class="form-label">Status</label>
                            <select class="form-control" id="planStatus" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Plan</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fetch and display customers with expiring plans
        async function fetchCustomers() {
            try {
                const response = await fetch("http://localhost:3001/customers");
                if (!response.ok) throw new Error("Failed to fetch customers");
                const customers = await response.json();
                displayExpiringCustomers(customers);
                populateCustomerManagement(customers);
            } catch (error) {
                console.error("Error fetching customer data:", error);
            }
        }
    
        // Display customers whose plans are expiring within 3 days
        function displayExpiringCustomers(customers) {
            const today = new Date();
            const tableBody = document.getElementById("customerTableBody");
            tableBody.innerHTML = "";
    
            customers.forEach(customer => {
                const expiryDate = new Date(customer.expiryDate);
                const timeDiff = (expiryDate - today) / (1000 * 60 * 60 * 24); // Difference in days
    
                if (timeDiff >= 0 && timeDiff <= 3) { // Expiring within 3 days
                    const row = `
                        <tr>
                            <td>${customer.name}</td>
                            <td>${customer.previousPlan}</td>
                            <td>${customer.expiryDate}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#customerModal"
                                    onclick="loadCustomerDetails('${customer.id}')">
                                    View Details
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                }
            });
        }
    
        // Populate customer management table
        function populateCustomerManagement(customers) {
            const tableBody = document.getElementById("customerManagementTableBody");
            tableBody.innerHTML = "";
            
            customers.forEach(customer => {
                const expiryDate = new Date(customer.expiryDate);
                const today = new Date();
                const timeDiff = (expiryDate - today) / (1000 * 60 * 60 * 24); // Difference in days
                
                let statusClass = "bg-success text-white";
                let statusText = "Active";
                
                if (timeDiff < 0) {
                    statusClass = "bg-danger text-white";
                    statusText = "Inactive";
                } else if (timeDiff <= 3) {
                    statusClass = "bg-warning text-dark";
                    statusText = "Expiring Soon";
                }
                
                const row = `
                    <tr data-status="${timeDiff < 0 ? 'inactive' : (timeDiff <= 3 ? 'expiring' : 'active')}">
                        <td>${customer.name}</td>
                        <td>${customer.phoneNumber || 'N/A'}</td>
                        <td>${customer.previousPlan}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>${customer.expiryDate}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#customerModal"
                                onclick="loadCustomerDetails('${customer.id}')">
                                View Details
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
            
            // Add event listeners for search and filter
            setupCustomerSearchAndFilter();
        }
        
        // Setup search and filter functionality for customers
        function setupCustomerSearchAndFilter() {
            const searchInput = document.getElementById("customerSearchInput");
            const searchButton = document.getElementById("customerSearchButton");
            const statusFilter = document.getElementById("planStatusFilter");
            
            const filterCustomers = () => {
                const searchTerm = searchInput.value.toLowerCase();
                const statusValue = statusFilter.value;
                const rows = document.querySelectorAll("#customerManagementTableBody tr");
                
                rows.forEach(row => {
                    const name = row.cells[0].textContent.toLowerCase();
                    const phone = row.cells[1].textContent.toLowerCase();
                    const rowStatus = row.getAttribute("data-status");
                    
                    const matchesSearch = name.includes(searchTerm) || phone.includes(searchTerm);
                    const matchesStatus = statusValue === "all" || rowStatus === statusValue;
                    
                    row.style.display = (matchesSearch && matchesStatus) ? "" : "none";
                });
            };
            
            searchButton.addEventListener("click", filterCustomers);
            searchInput.addEventListener("keyup", (e) => {
                if (e.key === "Enter") filterCustomers();
            });
            statusFilter.addEventListener("change", filterCustomers);
        }
    
        // Load customer details into the modal
function loadCustomerDetails(customerId) {
    const customerDetails = document.getElementById("customerDetails");
    customerDetails.innerHTML = '<p class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</p>';
    
    fetch(`http://localhost:3001/customers/${customerId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server returned ${response.status} ${response.statusText}`);
            }
            return response.json();
        })
        .then(customer => {
            const details = `
                <p><strong>Name:</strong> ${customer.name}</p>
                <p><strong>Phone Number:</strong> ${customer.phoneNumber || 'N/A'}</p>
                <p><strong>Previous Plan:</strong> ${customer.previousPlan}</p>
                <p><strong>Expiry Date:</strong> ${customer.expiryDate}</p>
                <h5>Transaction History:</h5>
                <ul>
                    ${customer.transactions ? customer.transactions.map(txn => `<li>${txn.date}: ${txn.amount} - ${txn.status}</li>`).join("") : "<li>No transactions</li>"}
                </ul>
                <h5>Available Plans:</h5>
                <ul>
                    ${customer.plans ? customer.plans.map(plan => `<li>${plan.planName} - ${plan.price}</li>`).join("") : "<li>No plans available</li>"}
                </ul>
                <h5>Payment Methods:</h5>
                <ul>
                    ${customer.paymentMethods ? customer.paymentMethods.map(pm => `<li>${pm.method} (Last Used: ${pm.lastUsed})</li>`).join("") : "<li>No payment methods</li>"}
                </ul>
            `;
            customerDetails.innerHTML = details;
        })
        .catch(error => {
            console.error("Error fetching customer details:", error);
            
            // Create fallback mock data for demonstration purposes
            // In a production environment, you might want to show a proper error message instead
            const mockCustomer = {
                name: "Customer " + customerId,
                phoneNumber: "123-456-" + Math.floor(1000 + Math.random() * 9000),
                previousPlan: "Premium " + Math.floor(Math.random() * 3 + 1),
                expiryDate: new Date(Date.now() + (Math.random() * 10 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
                transactions: [
                    { date: "2025-02-10", amount: "$" + (Math.floor(Math.random() * 50) + 10), status: "Completed" },
                    { date: "2025-01-15", amount: "$" + (Math.floor(Math.random() * 50) + 10), status: "Completed" }
                ],
                plans: [
                    { planName: "Monthly Data Pack", price: "$" + (Math.floor(Math.random() * 20) + 5) },
                    { planName: "Unlimited Calling", price: "$" + (Math.floor(Math.random() * 30) + 10) }
                ],
                paymentMethods: [
                    { method: "Credit Card", lastUsed: "2025-01-15" },
                    { method: "Net Banking", lastUsed: "2024-12-20" }
                ]
            };
            
            const details = `
                <div class="alert alert-warning mb-3">
                    <i class="fas fa-exclamation-triangle me-2"></i> Could not connect to server. Showing demo data.
                </div>
                <p><strong>Name:</strong> ${mockCustomer.name}</p>
                <p><strong>Phone Number:</strong> ${mockCustomer.phoneNumber}</p>
                <p><strong>Previous Plan:</strong> ${mockCustomer.previousPlan}</p>
                <p><strong>Expiry Date:</strong> ${mockCustomer.expiryDate}</p>
                <h5>Transaction History:</h5>
                <ul>
                    ${mockCustomer.transactions.map(txn => `<li>${txn.date}: ${txn.amount} - ${txn.status}</li>`).join("")}
                </ul>
                <h5>Available Plans:</h5>
                <ul>
                    ${mockCustomer.plans.map(plan => `<li>${plan.planName} - ${plan.price}</li>`).join("")}
                </ul>
                <h5>Payment Methods:</h5>
                <ul>
                    ${mockCustomer.paymentMethods.map(pm => `<li>${pm.method} (Last Used: ${pm.lastUsed})</li>`).join("")}
                </ul>
            `;
            customerDetails.innerHTML = details;
        });
}
    
        // Plans Management Script
        let plansData = {};
        let editingCategory = "popularPlan"; // Default category
        let editingIndex = -1;
    
        async function loadPlans() {
            try {
                const response = await fetch('./Plans.json');
                if (!response.ok) throw new Error("Failed to load plans");
                plansData = await response.json();
                
                // Add status to plans if it doesn't exist
                Object.keys(plansData).forEach(category => {
                    plansData[category].forEach(plan => {
                        if (!plan.hasOwnProperty('status')) {
                            plan.status = 'active';
                        }
                    });
                });
                
                displayPlans(editingCategory);
            } catch (error) {
                console.error("Error fetching plans:", error);
            }
        }
    
        function displayPlans(category) {
            editingCategory = category;
            const tableBody = document.getElementById("plansTable");
            tableBody.innerHTML = "";
    
            if (!plansData[category] || plansData[category].length === 0) {
                tableBody.innerHTML = "<tr><td colspan='7'>No plans available</td></tr>";
                return;
            }
    
            plansData[category].forEach((plan, index) => {
                const statusBadge = plan.status === 'active' ? 
                    '<span class="badge bg-success text-white">Active</span>' : 
                    '<span class="badge bg-danger text-white">Inactive</span>';
                
                const row = `
                    <tr>
                        <td>${plan.id}</td>
                        <td>${plan.price}</td>
                        <td>${plan.validity}</td>
                        <td>${plan.data}</td>
                        <td>${plan.desc || ""}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editPlan('${category}', ${index})">Edit</button>
                            <button class="btn btn-${plan.status === 'active' ? 'danger' : 'success'} btn-sm" 
                                onclick="togglePlanStatus('${category}', ${index})">
                                ${plan.status === 'active' ? 'Deactivate' : 'Activate'}
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }
    
        // Handle Category Change and Refresh Table
        document.getElementById("planCategory").addEventListener("change", function () {
            displayPlans(this.value);
        });
    
        // Add New Plan Button Click
        document.getElementById("addNewPlanBtn").addEventListener("click", function() {
            document.getElementById("planForm").reset();
            document.getElementById("editIndex").value = -1;
            document.getElementById("planStatus").value = "active";
            editingIndex = -1;
            document.getElementById("addPlanModalLabel").textContent = "Add New Plan";
            
            const modal = new bootstrap.Modal(document.getElementById("addPlanModal"));
            modal.show();
        });
    
        document.getElementById("planForm").addEventListener("submit", function (event) {
            event.preventDefault();
            const category = document.getElementById("planCategory").value;
            const planId = document.getElementById("planId").value.trim();
            const planPrice = document.getElementById("planPrice").value.trim();
            const planValidity = document.getElementById("planValidity").value.trim();
            const planData = document.getElementById("planData").value.trim();
            const planDescription = document.getElementById("planDescription").value.trim();
            const planStatus = document.getElementById("planStatus").value;
    
            const newPlan = { 
                id: planId, 
                price: planPrice, 
                validity: planValidity, 
                data: planData, 
                desc: planDescription, 
                status: planStatus 
            };
    
            if (editingIndex === -1) {
                if (!plansData[category]) {
                    plansData[category] = [];
                }
                plansData[category].push(newPlan);
            } else {
                plansData[category][editingIndex] = newPlan;
            }
    
            displayPlans(category);
            document.getElementById("planForm").reset();
            editingIndex = -1;
            
            // Correctly close the modal
            const modalElement = document.getElementById("addPlanModal");
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            } else {
                // Ensure backdrop is removed if modal instance doesn't exist
                document.querySelector('.modal-backdrop').remove();
                modalElement.classList.remove('show');
                modalElement.style.display = 'none';
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }
        });
    
        function editPlan(category, index) {
            const plan = plansData[category][index];
            document.getElementById("planCategory").value = category;
            document.getElementById("planId").value = plan.id;
            document.getElementById("planPrice").value = plan.price;
            document.getElementById("planValidity").value = plan.validity;
            document.getElementById("planData").value = plan.data;
            document.getElementById("planDescription").value = plan.desc || "";
            document.getElementById("planStatus").value = plan.status || "active";
            document.getElementById("editIndex").value = index;
            document.getElementById("addPlanModalLabel").textContent = "Edit Plan";
            editingIndex = index;
    
            const modal = new bootstrap.Modal(document.getElementById("addPlanModal"));
            modal.show();
        }
    
        function togglePlanStatus(category, index) {
            plansData[category][index].status = 
                plansData[category][index].status === 'active' ? 'inactive' : 'active';
            displayPlans(category);
        }
    
        // Load customers and plans on page load
        window.onload = function () {
            fetchCustomers();
            loadPlans();
            
            // Fix for modal backdrop issues
            document.addEventListener('hidden.bs.modal', function (event) {
                if (document.querySelector('.modal-backdrop')) {
                    document.querySelector('.modal-backdrop').remove();
                }
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            });
        };
    </script>
</body>
</html>