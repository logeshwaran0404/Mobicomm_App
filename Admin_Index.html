<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Prepaid Recharge Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <link href="AdminStyle.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">
    <div class="d-flex">
        <!-- Sidebar -->
        <div class="bg-white shadow-sm p-3" style="width: 250px;">
            <h2 class="text-primary">RechargeApp</h2>
            <nav class="nav flex-column mt-4">
                <a class="nav-link active text-primary" href="#"><i class="fas fa-home me-2"></i>Dashboard</a>
                <a class="nav-link text-dark" href="#" data-bs-toggle="modal" data-bs-target="#plansManagementModal">
                    <i class="fas fa-cogs me-2"></i>Plans Management
                </a>    
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-grow-1 p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Dashboard</h2>
                <div class="d-flex align-items-center">
                    <a class="navbar-brand" href="#" role="button" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <img src="Assets/Images/profile-icon.png" class="float-end me-3" alt="Profile" width="35" height="35">
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                        <li><a class="dropdown-item" href="#">Help</a></li>
                        <li><a class="dropdown-item" type="button" href="Admin_login.html">LogOut</a></li>
                    </ul>
                </div>
            </div>

            <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />

            <div class="container">
            <div class="row row-cols-1 row-cols-md-2 row-cols-xl-4">
                <div class="col">
                    <div class="card radius-10 border-start border-0 border-3 border-info">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div>
                                    <p class="mb-0 text-secondary">Total Orders</p>
                                    <h4 class="my-1 text-info">4805</h4>
                                    <p class="mb-0 font-13">+2.5% from last week</p>
                                </div>
                                <div class="widgets-icons-2 rounded-circle bg-gradient-scooter text-white ms-auto"><i class="fa fa-shopping-cart"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card radius-10 border-start border-0 border-3 border-danger">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <p class="mb-0 text-secondary">Total Revenue</p>
                                <h4 class="my-1 text-danger">$84,245</h4>
                                <p class="mb-0 font-13">+5.4% from last week</p>
                            </div>
                            <div class="widgets-icons-2 rounded-circle bg-gradient-bloody text-white ms-auto"><i class="fa fa-dollar"></i>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card radius-10 border-start border-0 border-3 border-success">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <p class="mb-0 text-secondary">Bounce Rate</p>
                                <h4 class="my-1 text-success">34.6%</h4>
                                <p class="mb-0 font-13">-4.5% from last week</p>
                            </div>
                            <div class="widgets-icons-2 rounded-circle bg-gradient-ohhappiness text-white ms-auto"><i class="fa fa-bar-chart"></i>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card radius-10 border-start border-0 border-3 border-warning">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <p class="mb-0 text-secondary">Total Customers</p>
                                <h4 class="my-1 text-warning">8.4K</h4>
                                <p class="mb-0 font-13">+8.4% from last week</p>
                            </div>
                            <div class="widgets-icons-2 rounded-circle bg-gradient-blooker text-white ms-auto"><i class="fa fa-users"></i>
                            </div>
                        </div>
                    </div>
                    </div>
                </div> 
                </div>
            </div>

            <!-- Expiring Plans Table -->
            <div class="card mb-4">
                <div class="card-header">
                    Customers with Plans Expiring Soon
                </div>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Previous Plan</th>
                            <th>Expiry Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="customerTableBody">
                        <!-- Data will be inserted dynamically -->
                    </tbody>
                </table>
            </div>
            <div class="card flex-fill w-50">
                <div class="card-header">
                    <h5 class="card-title mb-0">Recent Movement</h5>
                </div>
                <div class="card-body py-3">
                    <div class="chart chart-sm"><div class="chartjs-size-monitor"><div class="chartjs-size-monitor-expand"><div class=""></div></div><div class="chartjs-size-monitor-shrink"><div class=""></div></div></div>
                        <canvas id="chartjs-dashboard-line" style="display: block; height: 252px; width: 428px;" width="856" height="504" class="chart-line chartjs-render-monitor"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Details Modal -->
    <div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerModalLabel">Customer Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="customerDetails">
                    <!-- Customer details will be loaded dynamically -->
                </div>
            </div>
        </div>
</div>

<!-- Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    var chartsLine = document.querySelectorAll(".chart-line");
    
    chartsLine.forEach(function(chart) {
      if (!chart.getAttribute('data-chart-initialized')) {
          var ctx = chart.getContext("2d");
    
          var gradient = ctx.createLinearGradient(0, 0, 0, 225);
          gradient.addColorStop(0, "rgba(215, 227, 244, 1)");
          gradient.addColorStop(1, "rgba(215, 227, 244, 0)");
          // Line chart
          new Chart(ctx, {
              type: "line",
              data: {
                  labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                  datasets: [{
                      label: "Sales ($)",
                      fill: true,
                      backgroundColor: gradient,
                      borderColor: window.theme.primary,
                      data: [
                          2115,
                          1562,
                          1584,
                          1892,
                          1587,
                          1923,
                          2566,
                          2448,
                          2805,
                          3438,
                          2917,
                          3327
                      ]
                  }]
              },
              options: {
                  maintainAspectRatio: false,
                  legend: {
                      display: false
                  },
                  tooltips: {
                      intersect: false
                  },
                  hover: {
                      intersect: true
                  },
                  plugins: {
                      filler: {
                          propagate: false
                      }
                  },
                  scales: {
                      xAxes: [{
                          reverse: true,
                          gridLines: {
                              color: "rgba(0,0,0,0.0)"
                          }
                      }],
                      yAxes: [{
                          ticks: {
                              stepSize: 1000
                          },
                          display: true,
                          borderDash: [3, 3],
                          gridLines: {
                              color: "rgba(0,0,0,0.0)"
                          }
                      }]
                  }
              }
          });
          chart.setAttribute("data-chart-initialized", "true");
      }
    });
    </script>


    <!-- Plans Management Modal -->
    <div class="modal fade" id="plansManagementModal" tabindex="-1" aria-labelledby="plansManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="plansManagementModalLabel">Plans Management</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="planCategory" class="form-label">Plan Category</label>
                        <select class="form-control" id="planCategory" required>
                            <option value="popularPlan">Popular Plans</option>
                            <option value="unlimitedPlans">Unlimited Plans</option>
                            <option value="validityPlans">Validity Plans</option>
                            <option value="dataPlans">Data Plans</option>
                            <option value="talkTimePlans">TalkTime Plans</option>
                            <option value="roamingPlans">Roaming Plans</option>
                            <option value="specialOffers">Special Offers</option>
                            <option value="SuperSaver">Super Saver Plans</option>
                        </select>
                    </div>
                    <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addPlanModal">Add New Plan</button>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Plan ID</th>
                                <th>Price</th>
                                <th>Validity</th>
                                <th>Data</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="plansTable">
                            <!-- Plans will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Plan Modal -->
    <div class="modal fade" id="addPlanModal" tabindex="-1" aria-labelledby="addPlanModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPlanModalLabel">Add / Edit Plan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="planForm">
                        <input type="hidden" id="editIndex"> <!-- Hidden field to track edits -->
                        <div class="mb-3">
                            <label for="planId" class="form-label">Plan ID</label>
                            <input type="text" class="form-control" id="planId" required>
                        </div>
                        <div class="mb-3">
                            <label for="planPrice" class="form-label">Price</label>
                            <input type="text" class="form-control" id="planPrice" required>
                        </div>
                        <div class="mb-3">
                            <label for="planValidity" class="form-label">Validity</label>
                            <input type="text" class="form-control" id="planValidity" required>
                        </div>
                        <div class="mb-3">
                            <label for="planData" class="form-label">Data</label>
                            <input type="text" class="form-control" id="planData" required>
                        </div>
                        <div class="mb-3">
                            <label for="planDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="planDescription" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Plan</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fetch and display customers with expiring plans
        async function fetchCustomers() {
            try {
                const response = await fetch("http://localhost:3001/customers");
                if (!response.ok) throw new Error("Failed to fetch customers");
                const customers = await response.json();
                displayExpiringCustomers(customers);
            } catch (error) {
                console.error("Error fetching customer data:", error);
            }
        }
    
        // Display customers whose plans are expiring within 3 days
        function displayExpiringCustomers(customers) {
            const today = new Date();
            const tableBody = document.getElementById("customerTableBody");
            tableBody.innerHTML = "";
    
            customers.forEach(customer => {
                const expiryDate = new Date(customer.expiryDate);
                const timeDiff = (expiryDate - today) / (1000 * 60 * 60 * 24); // Difference in days
    
                if (timeDiff >= 0 && timeDiff <= 3) { // Expiring within 3 days
                    const row = `
                        <tr>
                            <td>${customer.name}</td>
                            <td>${customer.previousPlan}</td>
                            <td>${customer.expiryDate}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#customerModal"
                                    onclick="loadCustomerDetails(${JSON.stringify(customer).replace(/"/g, '&quot;')})">
                                    View Details
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                }
            });
        }
    
        // Load customer details into the modal
        function loadCustomerDetails(customer) {
            const details = `
                <p><strong>Name:</strong> ${customer.name}</p>
                <p><strong>Previous Plan:</strong> ${customer.previousPlan}</p>
                <p><strong>Expiry Date:</strong> ${customer.expiryDate}</p>
                <h5>Transaction History:</h5>
                <ul>
                    ${customer.transactions ? customer.transactions.map(txn => `<li>${txn.date}: ${txn.amount} - ${txn.status}</li>`).join("") : "<li>No transactions</li>"}
                </ul>
                <h5>Available Plans:</h5>
                <ul>
                    ${customer.plans ? customer.plans.map(plan => `<li>${plan.planName} - ${plan.price}</li>`).join("") : "<li>No plans available</li>"}
                </ul>
                <h5>Payment Methods:</h5>
                <ul>
                    ${customer.paymentMethods ? customer.paymentMethods.map(pm => `<li>${pm.method} (Last Used: ${pm.lastUsed})</li>`).join("") : "<li>No payment methods</li>"}
                </ul>
            `;
            document.getElementById("customerDetails").innerHTML = details;
        }
    
        // Plans Management Script
        let plansData = {};
        let editingCategory = "popularPlan"; // Default category
        let editingIndex = -1;
    
        async function loadPlans() {
            try {
                const response = await fetch('./Plans.json');
                if (!response.ok) throw new Error("Failed to load plans");
                plansData = await response.json();
                displayPlans(editingCategory);
            } catch (error) {
                console.error("Error fetching plans:", error);
            }
        }
    
        function displayPlans(category) {
            editingCategory = category;
            const tableBody = document.getElementById("plansTable");
            tableBody.innerHTML = "";
    
            if (!plansData[category] || plansData[category].length === 0) {
                tableBody.innerHTML = "<tr><td colspan='6'>No plans available</td></tr>";
                return;
            }
    
            plansData[category].forEach((plan, index) => {
                const row = `
                    <tr>
                        <td>${plan.id}</td>
                        <td>${plan.price}</td>
                        <td>${plan.validity}</td>
                        <td>${plan.data}</td>
                        <td>${plan.desc || ""}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editPlan('${category}', ${index})">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deletePlan('${category}', ${index})">Delete</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }
    
        // Handle Category Change and Refresh Table
        document.getElementById("planCategory").addEventListener("change", function () {
            displayPlans(this.value);
        });
    
        document.getElementById("planForm").addEventListener("submit", function (event) {
            event.preventDefault();
            const category = document.getElementById("planCategory").value;
            const planId = document.getElementById("planId").value.trim();
            const planPrice = document.getElementById("planPrice").value.trim();
            const planValidity = document.getElementById("planValidity").value.trim();
            const planData = document.getElementById("planData").value.trim();
            const planDescription = document.getElementById("planDescription").value.trim();
    
            const newPlan = { id: planId, price: planPrice, validity: planValidity, data: planData, desc: planDescription };
    
            if (editingIndex === -1) {
                plansData[category].push(newPlan);
            } else {
                plansData[category][editingIndex] = newPlan;
            }
    
            displayPlans(category);
            document.getElementById("planForm").reset();
            editingIndex = -1;
            bootstrap.Modal.getInstance(document.getElementById("addPlanModal")).hide();
        });
    
        function editPlan(category, index) {
            const plan = plansData[category][index];
            document.getElementById("planCategory").value = category;
            document.getElementById("planId").value = plan.id;
            document.getElementById("planPrice").value = plan.price;
            document.getElementById("planValidity").value = plan.validity;
            document.getElementById("planData").value = plan.data;
            document.getElementById("planDescription").value = plan.desc;
            editingIndex = index;
    
            new bootstrap.Modal(document.getElementById("addPlanModal")).show();
        }
    
        function deletePlan(category, index) {
            if (confirm("Are you sure you want to delete this plan?")) {
                plansData[category].splice(index, 1);
                displayPlans(category);
            }
        }
    
        // Load customers and plans on page load
        window.onload = function () {
            fetchCustomers();
            loadPlans();
        };
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>